<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8" />
<title>Protokol</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
  --bg:#0b0f14;
  --card:#141b24;
  --card2:#10161f;
  --muted:#9fb0c3;
  --text:#e8f0ff;

  --accent:#6ee7ff;
  --good:#2ee59d;
  --warn:#ffd166;
  --bad:#ff5c7a;
  --btn:#2a374a;
}

body{
  margin:0;
  background:
    radial-gradient(1200px 700px at 20% -10%, rgba(110,231,255,.14), transparent 60%),
    radial-gradient(900px 600px at 110% 10%, rgba(46,229,157,.12), transparent 60%),
    var(--bg);
  color:var(--text);
  font-family:Arial, sans-serif;
}

.container{max-width:1050px;margin:auto;padding:20px}
.section{
  background:linear-gradient(180deg, rgba(255,255,255,.04), transparent 55%), var(--card);
  border:1px solid rgba(110,231,255,.08);
  padding:16px;border-radius:14px;margin-bottom:16px;
  box-shadow:0 10px 30px rgba(0,0,0,.35);
}
.group{
  border:1px solid rgba(255,255,255,.08);
  background:linear-gradient(180deg, rgba(255,255,255,.03), transparent 55%), var(--card2);
  padding:16px;border-radius:14px;margin-bottom:16px;
}
h1{margin:8px 0 18px 0;letter-spacing:.3px;text-align:center}
h3{margin:0 0 12px 0}
h4{margin:12px 0 6px 0;color:var(--muted)}
label{display:block;margin-top:10px;color:var(--muted);font-size:13px}

input,select,textarea,button{
  width:100%;
  padding:10px;
  margin-top:6px;
  background:#0e141d;
  color:var(--text);
  border:1px solid rgba(255,255,255,.10);
  border-radius:10px;
  outline:none;
  box-sizing:border-box;
}
textarea{resize:vertical;min-height:90px}
input:focus,select:focus,textarea:focus{
  border-color:rgba(110,231,255,.55);
  box-shadow:0 0 0 4px rgba(110,231,255,.10);
}

button{
  background:linear-gradient(180deg, rgba(110,231,255,.18), rgba(110,231,255,.05)), var(--btn);
  border:1px solid rgba(110,231,255,.25);
  font-weight:800;
  cursor:pointer;
  display:flex;gap:10px;align-items:center;justify-content:center;
  transition:transform .08s ease, border-color .12s ease, filter .12s ease;
}
button:hover{transform:translateY(-1px);border-color:rgba(110,231,255,.45)}
button:active{transform:translateY(0)}
button.ghost{
  background:transparent;
  border:1px solid rgba(255,255,255,.14);
  font-weight:800;
}
button.danger{
  background:linear-gradient(180deg, rgba(255,92,122,.18), rgba(255,92,122,.06));
  border-color:rgba(255,92,122,.35);
}
button.danger:hover{filter:brightness(1.08)}
button.small{
  width:auto;
  padding:8px 10px;
  margin-top:0;
  border-radius:12px;
  font-weight:900;
}

.btnRow{display:flex;gap:10px;flex-wrap:wrap}
.btnRow button{flex:1;min-width:200px}
.hidden{display:none}

.apparow{
  border:1px solid rgba(255,255,255,.08);
  background:linear-gradient(180deg, rgba(46,229,157,.05), transparent 55%), #0c121a;
  padding:12px;margin-top:12px;border-radius:12px;
}

.badge{
  display:inline-flex;align-items:center;gap:8px;
  padding:6px 10px;border-radius:999px;
  font-size:12px;font-weight:800;
  border:1px solid rgba(255,255,255,.10);
  user-select:none;
}
.badge.good{background:rgba(46,229,157,.12);border-color:rgba(46,229,157,.30);color:var(--good)}
.badge.bad{background:rgba(255,92,122,.10);border-color:rgba(255,92,122,.28);color:var(--bad)}
.badge.warn{background:rgba(255,209,102,.10);border-color:rgba(255,209,102,.28);color:var(--warn)}

.titleRow{display:flex;align-items:center;justify-content:space-between;gap:10px}
.titleRow .left{display:flex;align-items:center;gap:10px}
.icon{
  width:34px;height:34px;border-radius:12px;
  display:grid;place-items:center;
  background:rgba(110,231,255,.10);
  border:1px solid rgba(110,231,255,.25);
}
.smallNote{color:var(--muted);font-size:12px;margin-top:4px}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media (max-width: 820px){ .grid2{grid-template-columns:1fr} }
hr{border:0;border-top:1px solid rgba(255,255,255,.08);margin:16px 0}
footer{text-align:center;color:#7f92a8;font-size:12px;margin-top:18px}

/* Validation */
.invalid{
  border-color:rgba(255,92,122,.85) !important;
  box-shadow:0 0 0 4px rgba(255,92,122,.12) !important;
}

/* Toast */
#toast{
  position:fixed;
  left:50%;
  bottom:18px;
  transform:translateX(-50%);
  z-index:9999;
  background:rgba(10,14,20,.92);
  border:1px solid rgba(255,255,255,.14);
  border-radius:14px;
  padding:10px 12px;
  display:none;
  min-width:280px;
  max-width:92vw;
  box-shadow:0 12px 40px rgba(0,0,0,.45);
}
#toast .row{display:flex;align-items:flex-start;gap:10px}
#toast .msg{color:var(--text);font-weight:800;font-size:13px;line-height:1.25}
#toast .sub{color:var(--muted);font-weight:700;font-size:12px;margin-top:2px}
</style>
</head>

<body>
<div class="container">
  <h1>üßæ Protokol</h1>

  <div class="section">
    <div class="titleRow">
      <div class="left">
        <div class="icon">‚ö°</div>
        <div>
          <h3 style="margin:0">Unos podataka</h3>
          <div class="smallNote">Auto-save ukljuƒçen ‚Ä¢ Grupe ‚Ä¢ Aparati ‚Ä¢ EX2/EX3/EX4 ‚Ä¢ Oprema ‚Ä¢ Server ‚Ä¢ UCAS ‚Ä¢ KODOVI</div>
        </div>
      </div>
      <span class="badge warn">üî¥ Live</span>
    </div>

    <div class="btnRow" style="margin-top:12px">
      <button onclick="addGroup()">‚ûï Dodaj grupu</button>
      <button onclick="generateText()">üìÑ Generiraj tekst</button>
      <button class="ghost" onclick="copyOutput()">üìã Kopiraj tekst</button>
      <button class="ghost" onclick="saveState()">üíæ Spremi</button>
      <button class="ghost" onclick="loadState()">üìÇ Uƒçitaj</button>
      <button class="danger" onclick="clearAll()">üßπ Oƒçisti sve</button>
    </div>

    <div class="smallNote" style="margin-top:10px">
      Spremanje se radi lokalno (u pregledniku). Ne ≈°alje ni≈°ta na internet.
    </div>
  </div>

  <div id="groups"></div>

  <div class="section hidden" id="outBox">
    <div class="titleRow">
      <div class="left">
        <div class="icon">üìÑ</div>
        <div>
          <h3 style="margin:0">Generirani tekst</h3>
          <div class="smallNote">Klikni ‚ÄúKopiraj tekst‚Äù za brzo lijepljenje u protokol.</div>
        </div>
      </div>
      <span class="badge good">‚úÖ Ready</span>
    </div>
    <textarea id="output" rows="25" style="margin-top:12px"></textarea>
  </div>

  <footer>verzija 13.1.26</footer>
</div>

<div id="toast">
  <div class="row">
    <div id="toastIcon" class="badge warn">‚ö†Ô∏è</div>
    <div>
      <div id="toastMsg" class="msg">Poruka</div>
      <div id="toastSub" class="sub"></div>
    </div>
  </div>
</div>

<script>
/* ------------------------------
   SERIJE + MODELI (dropdown)
--------------------------------*/
const seriesModels = {
  "Premier": [
    "EGT-VS5-4","EGT-VS6-4","EGT-VS8","EGT-VS9","EGT-VS9-1",
    "EGT-VS10-1","EGT-VS10-2","EGT-VS11-1","EGT-VS12","EGT-VS13",
    "EGT-VS14","EGT-VS15","EGT-VS16","EGT-VS17","EGT-VS18",
    "EGT-VS19","EGT-VS20"
  ],
  "G-Series": [
    "EGT-VS21","EGT-VS22","EGT-VS23","EGT-VS24","EGT-VS25",
    "EGT-VS26","EGT-VS27","EGT-VS28","EGT-VS29","EGT-VS30",
    "EGT-VS31","EGT-VS32","EGT-VS33","EGT-VS34","EGT-VS35",
    "EGT-VS36","EGT-VS37"
  ],
  "Supreme": [
    "EGT-VS40","EGT-VS41","EGT-VS42","EGT-VS43","EGT-VS44"
  ]
};

/* ------------------------------
   EX2: samo jedan dropdown (software)
--------------------------------*/
const ex2Software = [
  "Multi3 4_424E",
  "Multi4 3_326t",
  "Multi5 4_409_e",
  "Multi6 5_524_a_e",
  "Multi 3 4_R6_431_e",
  "Multi4 4_R6_414a_e",
  "Multi5 6_R6_422_e",
  "Multi6 6_R6_537_e",
  "Multi2 cat4cash 3_2_90_e",
  "Multi1 Egypt quest 2_3_92_e",
  "Fgrh 2_157_mu_91"
];

/* ------------------------------
   EX3 + EX4: kategorije + software
--------------------------------*/
const softwareData = {
  "3": {
    "COLLECTIONS": [
      "E3_C_Fruits-2_R6.2_358",
      "E3_C_Green_R5_353",
      "E3_C_Orange_R5_354",
      "E3_C_Purple_R5_357_P95",
      "E3_C_Red_R5_353",
      "E3_C_Union_R5_355",
      "E3_C_Purple_R6.2_363",
      "E3_C_Green_R6.2_358",
      "E3_C_Red_R6.2_358",
      "E3_C_Union_R6.2_358",
      "E3_C_Orange_R6.2_360",
      "E3_C_Gold_R7.2_410"
    ],
    "POWER": [
      "E3_P_Purple_R8_413",
      "E3_P_Green_R8_432",
      "E3_P_Fruits_RB.8_417"
    ],
    "GENERAL": [
      "E3_G_Red_R8_422",
      "E3_G_Fruits_R8_415",
      "E3_G_Green_R8_429",
      "E3_G_Green_R8B.2_501"
    ],
    "BELL LINK": [
      "E3_BL_BELL_LINK-1_R9B_520"
    ]
  },

  "4": {
    "BELL LINK": [
      "E4_J_BL_BL1_H1_S1.1.1",
      "E4_J_BL_BL1_H1_S1.1.3",
      "E4_J_BL_0x_BL1_H1_S2.5.22",
      "E4_J_BL_0x_BL2_H1_S1.1.10",
      "E4_J_BL_0x_BL2_H1_S2.5.21",
      "E4_J_BL_0x_BLB_H1_S1.5.10",
      "E4_J_BL_0x_BLB_H1_S2.5.11",
      "E4_J_BL_6x_BLB2_H1_S2.5.2"
    ],
    "Sheng Sheng": [
      "E4_J_SSBX_BC_H1_S1.1.4",
      "E4_S_G_BPRIZE_H1_S1.1.3",
      "E4_J_SSBX_SSBX_H1_S1.1.3"
    ],
    "Supreme Combo": [
      "E4_J_SCL_SCL_H1_S1.1.6"
    ],
    "Gods & Kings": [
      "E4_J_GKL_GK_H1_S1.1.11",
      "E4_J_GKL_0x_GK_H1_S1.1.18",
      "E4_J_GKL_0x_GK_H1_S2.5.31"
    ],
    "SUPREME": [
      "E4_S_SuS_MEGA_FRUITS_H1_S2.1.15",
      "E4_S_SuS_GREEN_H1_S1.1.8",
      "E4_S_SuS_GREEN_H1_S2.1.14",
      "E4_S_SuS_RED_H1_S2.1.14"
    ],
    "POWER": [
      "E4_M_P_BLUE_H1_S1.1.8",
      "E4_M_P_BLUE_H1_S1.1.8_1M"
    ],
    "GENERAL": [
      "E4_S_G_FRUITS_H1_S1.1.2",
      "E4_S_G_GOLD_H1_S1.1.8",
      "E4_S_G_GOLD_H1_S2.1.12",
      "E4_S_G_GREEN_H1_S1.1.4",
      "E4_S_G_GREEN_H1_S1.1.10",
      "E4_S_G_GREEN_H1_S2.1.18",
      "E4_S_G_RED_H1_S1.1.1",
      "E4_S_G_RED_H1_S2.1.14",
      "E4_S_G_BLUE_H1_S1.1.12",
      "E4_S_G_BLUE_H1_S1.1.14",
      "E4_S_G_BLUE_H1_S1.1.16",
      "E4_S_G_BLUE_H1_S1.1.18",
      "E4_S_G_BLUE_H1_S2.1.23"
    ]
  }
};

/* ------------------------------
   Toast
--------------------------------*/
let toastTimer = null;
function toast(msg, sub = "", type = "warn"){
  const el = document.getElementById("toast");
  const icon = document.getElementById("toastIcon");
  const m = document.getElementById("toastMsg");
  const s = document.getElementById("toastSub");
  m.textContent = msg;
  s.textContent = sub;

  icon.className = "badge " + (type === "good" ? "good" : type === "bad" ? "bad" : "warn");
  icon.textContent = type === "good" ? "‚úÖ" : type === "bad" ? "‚õî" : "‚ö†Ô∏è";

  el.style.display = "block";
  clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ el.style.display = "none"; }, 2600);
}

/* ------------------------------
   Validation helpers
--------------------------------*/
function clearInvalid(){ document.querySelectorAll(".invalid").forEach(el=>el.classList.remove("invalid")); }
function markInvalid(el){ if(el) el.classList.add("invalid"); }
function reqValue(el){ return !!(el && (el.value || "").trim()); }

/* ------------------------------
   UI helper: badge za Da/Ne
--------------------------------*/
function updateStatusBadge(selectEl){
  const label = selectEl.previousElementSibling;
  const badge = label?.querySelector(".status");
  if(!badge) return;
  const isYes = selectEl.value === "Da";
  badge.classList.toggle("good", isYes);
  badge.classList.toggle("bad", !isYes);
  badge.textContent = isYes ? "‚úÖ Da" : "‚ùå Ne";
}

/* Bill/Printer (tip + komada) */
function toggleTwoDeps(selectEl, depClass){
  updateStatusBadge(selectEl);
  const group = selectEl.closest(".group");
  group.querySelectorAll(depClass).forEach(d=>d.classList.toggle("hidden", selectEl.value !== "Da"));
  scheduleAutoSave();
}

/* show/hide helper za "Da/Ne" + dep block by selector */
function toggleDepBox(selectEl, depSelector){
  updateStatusBadge(selectEl);
  const group = selectEl.closest(".group");
  const dep = group.querySelector(depSelector);
  if(dep) dep.classList.toggle("hidden", selectEl.value !== "Da");
  scheduleAutoSave();
}

/* Server block */
function toggleServer(selectEl){
  updateStatusBadge(selectEl);
  const group = selectEl.closest(".group");
  const serverBox = group.querySelector(".server");
  serverBox.classList.toggle("hidden", selectEl.value !== "Da");
  scheduleAutoSave();
}

/* UCAS inside server */
function toggleUCAS(selectEl){
  updateStatusBadge(selectEl);
  const group = selectEl.closest(".group");
  const ucasBox = group.querySelector(".ucasDep");
  ucasBox.classList.toggle("hidden", selectEl.value !== "Da");
  scheduleAutoSave();
}

/* ------------------------------
   SAVE/LOAD (manual + auto)
--------------------------------*/
const STORAGE_KEY = "protokol_v13_1_26_state";
let autoSaveTimer = null;

function scheduleAutoSave(){
  clearTimeout(autoSaveTimer);
  autoSaveTimer = setTimeout(()=> {
    try{
      const data = exportState();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
      // bez toasta na svaku promjenu (da ne smeta)
    }catch(e){}
  }, 450);
}

function saveState(){
  try{
    const data = exportState();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    toast("Spremljeno", "Podaci su spremljeni u pregledniku.", "good");
  } catch(e){
    toast("Gre≈°ka kod spremanja", String(e?.message || e), "bad");
  }
}

function loadState(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw){
      toast("Nema spremljenih podataka", "Upi≈°i ne≈°to pa ƒáe se auto-spremiti.", "warn");
      return;
    }
    const data = JSON.parse(raw);
    importState(data);
    toast("Uƒçitano", "Podaci su vraƒáeni.", "good");
  } catch(e){
    toast("Gre≈°ka kod uƒçitavanja", String(e?.message || e), "bad");
  }
}

function clearAll(){
  if(!confirm("Oƒçistiti sve grupe i tekst?")) return;
  document.getElementById("groups").innerHTML = "";
  document.getElementById("output").value = "";
  document.getElementById("outBox").classList.add("hidden");
  groupCount = 0;
  localStorage.removeItem(STORAGE_KEY);
  toast("Oƒçi≈°ƒáeno", "Sve je resetirano.", "good");
}

/* ------------------------------
   GRUPE
--------------------------------*/
let groupCount = 0;

function addGroup(prefillData = null){
  groupCount++;

  const g = document.createElement("div");
  g.className = "group";
  g.innerHTML = `
    <div class="titleRow">
      <div class="left">
        <div class="icon">üé∞</div>
        <div>
          <h3 class="groupTitle" style="margin:0">Grupa ${groupCount}</h3>
          <div class="smallNote">Serija + model su zajedniƒçki za cijelu grupu</div>
        </div>
      </div>
      <div style="display:flex;gap:10px;align-items:center">
        <button class="small danger" onclick="deleteGroup(this)">üóëÔ∏è Obri≈°i grupu</button>
      </div>
    </div>

    <div class="grid2" style="margin-top:10px">
      <div>
        <label>üî¢ Broj aparata</label>
        <input class="apCount" type="number" min="0" onchange="renderAparati(this)">
      </div>

      <div>
        <label>üì¶ Serija aparata</label>
        <select class="series" onchange="updateModels(this)">
          <option value="">-- odaberi --</option>
          <option value="Premier">Premier</option>
          <option value="G-Series">G-Series</option>
          <option value="Supreme">Supreme</option>
        </select>
      </div>
    </div>

    <label>üè∑Ô∏è Model aparata</label>
    <select class="model">
      <option value="">-- odaberi model --</option>
    </select>

    <div class="aparati"></div>

    <hr>

    <h4>üß∞ Oprema</h4>

    <div class="grid2">
      <div>
        <label>üíµ Bill Acceptor <span class="badge bad status">‚ùå Ne</span></label>
        <select class="billYesNo" onchange="toggleTwoDeps(this,'.billDep')">
          <option>Ne</option><option>Da</option>
        </select>
        <select class="hidden billDep billType">
          <option value="">MEI / JCM</option>
          <option>MEI</option><option>JCM</option>
        </select>
        <input type="number" class="hidden billDep billCount" placeholder="Broj komada">
      </div>

      <div>
        <label>üñ®Ô∏è Printer <span class="badge bad status">‚ùå Ne</span></label>
        <select class="prnYesNo" onchange="toggleTwoDeps(this,'.prnDep')">
          <option>Ne</option><option>Da</option>
        </select>
        <select class="hidden prnDep prnType">
          <option>Ithaca</option><option>Ithaca Edge</option><option>Gen2</option><option>Gen5</option>
        </select>
        <input type="number" class="hidden prnDep prnCount" placeholder="Broj komada">
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>ü™ë Stolica <span class="badge bad status">‚ùå Ne</span></label>
        <select class="stolYesNo" onchange="toggleDepBox(this,'.stolDep')">
          <option>Ne</option><option>Da</option>
        </select>
        <div class="hidden stolDep">
          <input class="stolText" placeholder="Upis (koliƒçina / opis / napomena)">
        </div>
      </div>

      <div>
        <label>üß± Postolje <span class="badge bad status">‚ùå Ne</span></label>
        <select class="postYesNo" onchange="toggleDepBox(this,'.postDep')">
          <option>Ne</option><option>Da</option>
        </select>
        <div class="hidden postDep">
          <input class="postText" placeholder="Upis (koliƒçina / opis / napomena)">
        </div>
      </div>
    </div>

    <div class="grid2">
      <div>
        <label>üì∫ Signage <span class="badge bad status">‚ùå Ne</span></label>
        <select class="signYesNo" onchange="toggleDepBox(this,'.signDep')">
          <option>Ne</option><option>Da</option>
        </select>
        <div class="hidden signDep">
          <label style="margin-top:8px">Serijski broj</label>
          <input class="signSN" placeholder="Serijski broj">
          <label style="margin-top:8px">Medij</label>
          <input class="signMedia" placeholder="Medij (slobodan unos)">
        </div>
      </div>

      <div>
        <label>üñß Server <span class="badge bad status">‚ùå Ne</span></label>
        <select class="srvYesNo" onchange="toggleServer(this)">
          <option>Ne</option><option>Da</option>
        </select>

        <div class="server hidden">
          <label>JPSN</label><input class="srvJpsn" placeholder="JPSN">
          <label>Verzija (PPC)</label>
          <select class="srvPpc">
            <option>PPC2_8_148</option>
            <option>PPC2_10_189</option>
            <option>PPC3_G2_13_332</option>
            <option>PPC3_G3_13_361</option>
            <option>PPC3_G3_14_372</option>
          </select>

          <h4>Mini</h4>
          <input class="miniV" placeholder="Visible">
          <input class="miniH" placeholder="Hidden">
          <input class="miniB" placeholder="Min bet">

          <h4>Mid</h4>
          <input class="midV" placeholder="Visible">
          <input class="midH" placeholder="Hidden">
          <input class="midB" placeholder="Min bet">

          <h4>Super</h4>
          <input class="supV" placeholder="Visible">
          <input class="supH" placeholder="Hidden">
          <input class="supB" placeholder="Min bet">

          <hr>

          <label>üõ°Ô∏è UCAS <span class="badge bad status">‚ùå Ne</span></label>
          <select class="ucasYesNo" onchange="toggleUCAS(this)">
            <option>Ne</option><option>Da</option>
          </select>
          <div class="hidden ucasDep">
            <input class="ucasText" placeholder="UCAS (slobodan unos / napomena)">
          </div>
        </div>
      </div>
    </div>

    <hr>

    <h4>üîê KODOVI</h4>
    <label>Komentar / napomena</label>
    <textarea class="codesNote" placeholder="npr. konverzije kodovi 180 dana, ostalo no limit"></textarea>
  `;

  document.getElementById("groups").appendChild(g);

  // init badges to "Ne"
  g.querySelectorAll('select').forEach(sel=>{
    if(sel.previousElementSibling?.querySelector(".status")) updateStatusBadge(sel);
  });

  // optional prefill
  if(prefillData) applyGroupData(g, prefillData);

  reindexGroups();
  scheduleAutoSave();
}

function deleteGroup(btn){
  const g = btn.closest(".group");
  if(!g) return;
  g.remove();
  reindexGroups();
  scheduleAutoSave();
  toast("Grupa obrisana", "", "good");
}

function reindexGroups(){
  [...document.querySelectorAll(".group")].forEach((g, idx)=>{
    const title = g.querySelector(".groupTitle");
    if(title) title.textContent = `Grupa ${idx+1}`;
  });
}

function updateModels(sel){
  const group = sel.closest(".group");
  const modelSelect = group.querySelector(".model");
  modelSelect.innerHTML = `<option value="">-- odaberi model --</option>`;
  (seriesModels[sel.value] || []).forEach(m=>{
    const o = document.createElement("option");
    o.value = m;
    o.textContent = m;
    modelSelect.appendChild(o);
  });
  scheduleAutoSave();
}

/* ------------------------------
   APARATI
--------------------------------*/
function renderAparati(inp, prefillAparati = null){
  const group = inp.closest(".group");
  const box = group.querySelector(".aparati");
  box.innerHTML = "";

  const n = Math.max(0, Number(inp.value || 0));
  for(let i=1;i<=n;i++){
    box.appendChild(makeAparatRow(i));
  }

  if(Array.isArray(prefillAparati)){
    const rows = [...group.querySelectorAll(".apparow")];
    rows.forEach((row, idx)=>{
      if(prefillAparati[idx]) applyAparatData(row, prefillAparati[idx]);
    });
  }

  scheduleAutoSave();
}

function makeAparatRow(index){
  const wrap = document.createElement("div");
  wrap.className = "apparow";
  wrap.innerHTML = `
    <div class="titleRow">
      <div class="left">
        <div class="icon">üß©</div>
        <div>
          <h4 class="apTitle" style="margin:0">Aparat ${index}</h4>
          <div class="smallNote">Serijski broj ‚Ä¢ broj excitera ‚Ä¢ exciter ‚Ä¢ software</div>
        </div>
      </div>
      <button class="small danger" onclick="deleteAparat(this)">üóëÔ∏è</button>
    </div>

    <label>Serijski broj</label>
    <input class="sn" placeholder="Serijski broj aparata">

    <label>Broj excitera</label>
    <input class="exno" placeholder="Broj excitera">

    <label>‚öôÔ∏è Exciter</label>
    <select class="exSel" onchange="onExciterChange(this)">
      <option value="">--</option>
      <option value="2">2</option>
      <option value="3">3</option>
      <option value="4">4</option>
    </select>

    <div class="exSoft hidden">
      <h4 style="margin-top:10px">üß† Software</h4>

      <label class="softcat-label">Software kategorija</label>
      <select class="softcat hidden" onchange="showSoftList(this)">
        <option value="">-- odaberi --</option>
      </select>

      <label class="softlist-label hidden">Software</label>
      <select class="softlist hidden">
        <option value="">-- odaberi --</option>
      </select>
    </div>
  `;
  return wrap;
}

function deleteAparat(btn){
  const row = btn.closest(".apparow");
  const group = btn.closest(".group");
  if(!row || !group) return;
  row.remove();

  const apCount = group.querySelector(".apCount");
  const count = group.querySelectorAll(".apparow").length;
  apCount.value = count;

  reindexAparati(group);
  scheduleAutoSave();
  toast("Aparat obrisan", "", "good");
}

function reindexAparati(group){
  [...group.querySelectorAll(".apparow")].forEach((r, idx)=>{
    const t = r.querySelector(".apTitle");
    if(t) t.textContent = `Aparat ${idx+1}`;
  });
}

/* ------------------------------
   EX2 / EX3 / EX4 LOGIKA (software)
--------------------------------*/
function onExciterChange(sel){
  const row = sel.closest(".apparow");
  const exc = (sel.value || "").trim();

  const softBox  = row.querySelector(".exSoft");
  const catLabel = row.querySelector(".softcat-label");
  const catSel   = row.querySelector(".softcat");
  const listLabel= row.querySelector(".softlist-label");
  const listSel  = row.querySelector(".softlist");

  // reset
  softBox.classList.add("hidden");
  catLabel.classList.add("hidden");
  catSel.classList.add("hidden");
  listLabel.classList.add("hidden");
  listSel.classList.add("hidden");

  catSel.innerHTML  = `<option value="">-- odaberi --</option>`;
  listSel.innerHTML = `<option value="">-- odaberi --</option>`;
  listLabel.textContent = "Software";

  if(!exc){ scheduleAutoSave(); return; }

  softBox.classList.remove("hidden");

  if(exc === "2"){
    listLabel.classList.remove("hidden");
    listSel.classList.remove("hidden");
    ex2Software.forEach(s=>{
      const o=document.createElement("option");
      o.value=s; o.textContent=s;
      listSel.appendChild(o);
    });
    scheduleAutoSave();
    return;
  }

  if(exc === "3" || exc === "4"){
    catLabel.classList.remove("hidden");
    catSel.classList.remove("hidden");

    Object.keys(softwareData[exc] || {}).forEach(k=>{
      const o=document.createElement("option");
      o.value=k; o.textContent=k;
      catSel.appendChild(o);
    });
    scheduleAutoSave();
    return;
  }

  scheduleAutoSave();
}

function showSoftList(catSel){
  const row = catSel.closest(".apparow");
  const exc = (row.querySelector(".exSel").value || "").trim();
  const key = (catSel.value || "").trim();

  const listLabel = row.querySelector(".softlist-label");
  const listSel = row.querySelector(".softlist");

  listSel.innerHTML = `<option value="">-- odaberi --</option>`;

  const items = softwareData?.[exc]?.[key] || [];
  items.forEach(s=>{
    const o=document.createElement("option");
    o.value=s; o.textContent=s;
    listSel.appendChild(o);
  });

  const show = !!key;
  listLabel.classList.toggle("hidden", !show);
  listSel.classList.toggle("hidden", !show);

  scheduleAutoSave();
}

/* ------------------------------
   COPY
--------------------------------*/
function copyOutput(){
  const out = document.getElementById("output");
  const text = (out?.value || "").trim();
  if(!text){
    toast("Nema teksta za kopirati", "Prvo klikni ‚ÄúGeneriraj tekst‚Äù.", "warn");
    return;
  }

  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=>{
      toast("Kopirano u clipboard", "", "good");
    }).catch(()=> fallbackCopy(text));
  } else {
    fallbackCopy(text);
  }
}

function fallbackCopy(text){
  const ta = document.createElement("textarea");
  ta.value = text;
  ta.style.position="fixed";
  ta.style.left="-9999px";
  document.body.appendChild(ta);
  ta.select();
  try{
    document.execCommand("copy");
    toast("Kopirano u clipboard", "", "good");
  } catch(e){
    toast("Ne mogu kopirati", "Clipboard blokiran u pregledniku.", "bad");
  }
  document.body.removeChild(ta);
}

/* ------------------------------
   EXPORT/IMPORT STATE
--------------------------------*/
function exportState(){
  const groups = [...document.querySelectorAll(".group")];
  return {
    version: "13.1.26",
    groups: groups.map(g => collectGroupData(g))
  };
}

function importState(state){
  document.getElementById("groups").innerHTML = "";
  groupCount = 0;

  const groups = Array.isArray(state?.groups) ? state.groups : [];
  groups.forEach(gd => addGroup(gd));

  const out = document.getElementById("output");
  if(out.value.trim()) document.getElementById("outBox").classList.remove("hidden");
}

function collectGroupData(g){
  const aparati = [...g.querySelectorAll(".apparow")].map(a => collectAparatData(a));
  return {
    apCount: g.querySelector(".apCount")?.value || "",
    series: g.querySelector(".series")?.value || "",
    model: g.querySelector(".model")?.value || "",

    billYes: g.querySelector(".billYesNo")?.value || "Ne",
    billType: g.querySelector(".billType")?.value || "",
    billCount: g.querySelector(".billCount")?.value || "",

    prnYes: g.querySelector(".prnYesNo")?.value || "Ne",
    prnType: g.querySelector(".prnType")?.value || "",
    prnCount: g.querySelector(".prnCount")?.value || "",

    stolYes: g.querySelector(".stolYesNo")?.value || "Ne",
    stolText: g.querySelector(".stolText")?.value || "",

    postYes: g.querySelector(".postYesNo")?.value || "Ne",
    postText: g.querySelector(".postText")?.value || "",

    signYes: g.querySelector(".signYesNo")?.value || "Ne",
    signSN: g.querySelector(".signSN")?.value || "",
    signMedia: g.querySelector(".signMedia")?.value || "",

    srvYes: g.querySelector(".srvYesNo")?.value || "Ne",
    srvJpsn: g.querySelector(".srvJpsn")?.value || "",
    srvPpc: g.querySelector(".srvPpc")?.value || "",
    miniV: g.querySelector(".miniV")?.value || "",
    miniH: g.querySelector(".miniH")?.value || "",
    miniB: g.querySelector(".miniB")?.value || "",
    midV: g.querySelector(".midV")?.value || "",
    midH: g.querySelector(".midH")?.value || "",
    midB: g.querySelector(".midB")?.value || "",
    supV: g.querySelector(".supV")?.value || "",
    supH: g.querySelector(".supH")?.value || "",
    supB: g.querySelector(".supB")?.value || "",

    ucasYes: g.querySelector(".ucasYesNo")?.value || "Ne",
    ucasText: g.querySelector(".ucasText")?.value || "",

    codesNote: g.querySelector(".codesNote")?.value || "",

    aparati
  };
}

function collectAparatData(a){
  return {
    sn: a.querySelector(".sn")?.value || "",
    exno: a.querySelector(".exno")?.value || "",
    exc: a.querySelector(".exSel")?.value || "",
    cat: a.querySelector(".softcat")?.value || "",
    soft: a.querySelector(".softlist")?.value || ""
  };
}

function applyGroupData(g, d){
  g.querySelector(".apCount").value = d.apCount || "";
  g.querySelector(".series").value = d.series || "";
  updateModels(g.querySelector(".series"));
  g.querySelector(".model").value = d.model || "";

  renderAparati(g.querySelector(".apCount"), d.aparati || []);

  const setYesNo = (sel, val) => { sel.value = val || "Ne"; updateStatusBadge(sel); };

  setYesNo(g.querySelector(".billYesNo"), d.billYes);
  toggleTwoDeps(g.querySelector(".billYesNo"), ".billDep");
  g.querySelector(".billType").value = d.billType || "";
  g.querySelector(".billCount").value = d.billCount || "";

  setYesNo(g.querySelector(".prnYesNo"), d.prnYes);
  toggleTwoDeps(g.querySelector(".prnYesNo"), ".prnDep");
  g.querySelector(".prnType").value = d.prnType || "";
  g.querySelector(".prnCount").value = d.prnCount || "";

  setYesNo(g.querySelector(".stolYesNo"), d.stolYes);
  toggleDepBox(g.querySelector(".stolYesNo"), ".stolDep");
  g.querySelector(".stolText").value = d.stolText || "";

  setYesNo(g.querySelector(".postYesNo"), d.postYes);
  toggleDepBox(g.querySelector(".postYesNo"), ".postDep");
  g.querySelector(".postText").value = d.postText || "";

  setYesNo(g.querySelector(".signYesNo"), d.signYes);
  toggleDepBox(g.querySelector(".signYesNo"), ".signDep");
  g.querySelector(".signSN").value = d.signSN || "";
  g.querySelector(".signMedia").value = d.signMedia || "";

  setYesNo(g.querySelector(".srvYesNo"), d.srvYes);
  toggleServer(g.querySelector(".srvYesNo"));
  g.querySelector(".srvJpsn").value = d.srvJpsn || "";
  g.querySelector(".srvPpc").value = d.srvPpc || "";
  g.querySelector(".miniV").value = d.miniV || "";
  g.querySelector(".miniH").value = d.miniH || "";
  g.querySelector(".miniB").value = d.miniB || "";
  g.querySelector(".midV").value = d.midV || "";
  g.querySelector(".midH").value = d.midH || "";
  g.querySelector(".midB").value = d.midB || "";
  g.querySelector(".supV").value = d.supV || "";
  g.querySelector(".supH").value = d.supH || "";
  g.querySelector(".supB").value = d.supB || "";

  setYesNo(g.querySelector(".ucasYesNo"), d.ucasYes);
  toggleUCAS(g.querySelector(".ucasYesNo"));
  g.querySelector(".ucasText").value = d.ucasText || "";

  g.querySelector(".codesNote").value = d.codesNote || "";

  scheduleAutoSave();
}

function applyAparatData(row, d){
  row.querySelector(".sn").value = d.sn || "";
  row.querySelector(".exno").value = d.exno || "";
  row.querySelector(".exSel").value = d.exc || "";
  onExciterChange(row.querySelector(".exSel"));

  if(d.exc === "2"){
    row.querySelector(".softlist").value = d.soft || "";
  }

  if(d.exc === "3" || d.exc === "4"){
    row.querySelector(".softcat").value = d.cat || "";
    showSoftList(row.querySelector(".softcat"));
    row.querySelector(".softlist").value = d.soft || "";
  }
}

/* ------------------------------
   OUTPUT + VALIDACIJE
--------------------------------*/
function generateText(){
  clearInvalid();

  const groups = [...document.querySelectorAll(".group")];
  if(groups.length === 0){
    toast("Nema grupa", "Dodaj barem jednu grupu.", "warn");
    return;
  }

  let firstInvalid = null;
  let errCount = 0;

  groups.forEach((g)=>{
    const seriesEl = g.querySelector(".series");
    const modelEl = g.querySelector(".model");
    const apCountEl = g.querySelector(".apCount");

    if(!reqValue(apCountEl)){ markInvalid(apCountEl); firstInvalid ||= apCountEl; errCount++; }
    if(!reqValue(seriesEl)){ markInvalid(seriesEl); firstInvalid ||= seriesEl; errCount++; }
    if(!reqValue(modelEl)){ markInvalid(modelEl); firstInvalid ||= modelEl; errCount++; }

    [...g.querySelectorAll(".apparow")].forEach((a)=>{
      const sn = a.querySelector(".sn");
      const exno = a.querySelector(".exno");
      const exc = a.querySelector(".exSel");
      const cat = a.querySelector(".softcat");
      const soft = a.querySelector(".softlist");

      if(!reqValue(sn)){ markInvalid(sn); firstInvalid ||= sn; errCount++; }
      if(!reqValue(exno)){ markInvalid(exno); firstInvalid ||= exno; errCount++; }
      if(!reqValue(exc)){ markInvalid(exc); firstInvalid ||= exc; errCount++; }

      const excVal = (exc.value||"").trim();
      if(excVal === "2"){
        if(!reqValue(soft)){ markInvalid(soft); firstInvalid ||= soft; errCount++; }
      }
      if(excVal === "3" || excVal === "4"){
        if(!reqValue(cat)){ markInvalid(cat); firstInvalid ||= cat; errCount++; }
        if(!reqValue(soft)){ markInvalid(soft); firstInvalid ||= soft; errCount++; }
      }
    });

    const billYes = g.querySelector(".billYesNo")?.value || "Ne";
    if(billYes === "Da"){
      const bt = g.querySelector(".billType");
      const bc = g.querySelector(".billCount");
      if(!reqValue(bt)){ markInvalid(bt); firstInvalid ||= bt; errCount++; }
      if(!reqValue(bc)){ markInvalid(bc); firstInvalid ||= bc; errCount++; }
    }

    const prnYes = g.querySelector(".prnYesNo")?.value || "Ne";
    if(prnYes === "Da"){
      const pt = g.querySelector(".prnType");
      const pc = g.querySelector(".prnCount");
      if(!reqValue(pt)){ markInvalid(pt); firstInvalid ||= pt; errCount++; }
      if(!reqValue(pc)){ markInvalid(pc); firstInvalid ||= pc; errCount++; }
    }

    const stolYes = g.querySelector(".stolYesNo")?.value || "Ne";
    if(stolYes === "Da"){
      const st = g.querySelector(".stolText");
      if(!reqValue(st)){ markInvalid(st); firstInvalid ||= st; errCount++; }
    }

    const postYes = g.querySelector(".postYesNo")?.value || "Ne";
    if(postYes === "Da"){
      const ps = g.querySelector(".postText");
      if(!reqValue(ps)){ markInvalid(ps); firstInvalid ||= ps; errCount++; }
    }

    const signYes = g.querySelector(".signYesNo")?.value || "Ne";
    if(signYes === "Da"){
      const ssn = g.querySelector(".signSN");
      const sm = g.querySelector(".signMedia");
      if(!reqValue(ssn)){ markInvalid(ssn); firstInvalid ||= ssn; errCount++; }
      if(!reqValue(sm)){ markInvalid(sm); firstInvalid ||= sm; errCount++; }
    }

    const srvYes = g.querySelector(".srvYesNo")?.value || "Ne";
    if(srvYes === "Da"){
      const jpsn = g.querySelector(".srvJpsn");
      if(!reqValue(jpsn)){ markInvalid(jpsn); firstInvalid ||= jpsn; errCount++; }

      const ucasYes = g.querySelector(".ucasYesNo")?.value || "Ne";
      if(ucasYes === "Da"){
        const ut = g.querySelector(".ucasText");
        if(!reqValue(ut)){ markInvalid(ut); firstInvalid ||= ut; errCount++; }
      }
    }
  });

  if(errCount){
    firstInvalid?.scrollIntoView({behavior:"smooth", block:"center"});
    toast("Nedostaju obavezna polja", `Ispravi oznaƒçena polja (ukupno: ${errCount}).`, "bad");
    return;
  }

  let t = "";
  groups.forEach((g,gi)=>{
    const series = g.querySelector(".series")?.value || "";
    const model  = g.querySelector(".model")?.value || "";

    t += `Grupa ${gi+1}\n`;
    t += `Serija: ${series}\n`;
    t += `Model: ${model}\n\n`;

    g.querySelectorAll(".apparow").forEach((a,ai)=>{
      const sn   = a.querySelector(".sn")?.value || "";
      const exno = a.querySelector(".exno")?.value || "";
      const exc  = a.querySelector(".exSel")?.value || "";
      const cat  = a.querySelector(".softcat")?.value || "";
      const soft = a.querySelector(".softlist")?.value || "";

      t += `Aparat ${ai+1}:\n`;
      t += `  Serijski broj: ${sn}\n`;
      t += `  Broj excitera: ${exno}\n`;
      t += `  Exciter: ${exc}\n`;

      if(exc === "2"){
        t += `  Software: ${soft}\n`;
      } else if(exc === "3" || exc === "4"){
        t += `  Software kategorija: ${cat}\n`;
        t += `  Software: ${soft}\n`;
      }
      t += "\n";
    });

    t += "Oprema:\n";

    const billYes = g.querySelector(".billYesNo")?.value || "Ne";
    t += `Bill Acceptor: ${billYes}\n`;
    if(billYes === "Da"){
      t += `Tip: ${g.querySelector(".billType")?.value || ""}\n`;
      t += `Komada: ${g.querySelector(".billCount")?.value || ""}\n`;
    }

    const prnYes = g.querySelector(".prnYesNo")?.value || "Ne";
    t += `Printer: ${prnYes}\n`;
    if(prnYes === "Da"){
      t += `Tip: ${g.querySelector(".prnType")?.value || ""}\n`;
      t += `Komada: ${g.querySelector(".prnCount")?.value || ""}\n`;
    }

    const stolYes = g.querySelector(".stolYesNo")?.value || "Ne";
    t += `Stolica: ${stolYes}\n`;
    if(stolYes === "Da"){
      t += `Napomena: ${g.querySelector(".stolText")?.value || ""}\n`;
    }

    const postYes = g.querySelector(".postYesNo")?.value || "Ne";
    t += `Postolje: ${postYes}\n`;
    if(postYes === "Da"){
      t += `Napomena: ${g.querySelector(".postText")?.value || ""}\n`;
    }

    const signYes = g.querySelector(".signYesNo")?.value || "Ne";
    t += `Signage: ${signYes}\n`;
    if(signYes === "Da"){
      t += `Serijski broj: ${g.querySelector(".signSN")?.value || ""}\n`;
      t += `Medij: ${g.querySelector(".signMedia")?.value || ""}\n`;
    }

    const srvYes = g.querySelector(".srvYesNo")?.value || "Ne";
    t += `Server: ${srvYes}\n`;
    if(srvYes === "Da"){
      t += "Server:\n";
      t += `JPSN: ${g.querySelector(".srvJpsn")?.value || ""}\n`;
      t += `Verzija (PPC): ${g.querySelector(".srvPpc")?.value || ""}\n`;

      t += "Mini:\n";
      t += `  Visible: ${g.querySelector(".miniV")?.value || ""}\n`;
      t += `  Hidden: ${g.querySelector(".miniH")?.value || ""}\n`;
      t += `  Min bet: ${g.querySelector(".miniB")?.value || ""}\n`;

      t += "Mid:\n";
      t += `  Visible: ${g.querySelector(".midV")?.value || ""}\n`;
      t += `  Hidden: ${g.querySelector(".midH")?.value || ""}\n`;
      t += `  Min bet: ${g.querySelector(".midB")?.value || ""}\n`;

      t += "Super:\n";
      t += `  Visible: ${g.querySelector(".supV")?.value || ""}\n`;
      t += `  Hidden: ${g.querySelector(".supH")?.value || ""}\n`;
      t += `  Min bet: ${g.querySelector(".supB")?.value || ""}\n`;

      const ucasYes = g.querySelector(".ucasYesNo")?.value || "Ne";
      t += `UCAS: ${ucasYes}\n`;
      if(ucasYes === "Da"){
        t += `Napomena: ${g.querySelector(".ucasText")?.value || ""}\n`;
      }
    }

    const codes = (g.querySelector(".codesNote")?.value || "").trim();
    t += `KODOVI:\n`;
    t += codes ? `${codes}\n` : `-\n`;

    t += "\n----------------------------------------\n\n";
  });

  document.getElementById("output").value = t.trim();
  document.getElementById("outBox").classList.remove("hidden");
  toast("Tekst generiran", "Mo≈æe≈° ga kopirati s ‚ÄúKopiraj tekst‚Äù.", "good");
}

/* ------------------------------
   Obri≈°i grupu helper
--------------------------------*/
function deleteGroup(btn){
  const g = btn.closest(".group");
  if(!g) return;
  g.remove();
  reindexGroups();
  scheduleAutoSave();
  toast("Grupa obrisana", "", "good");
}

/* ------------------------------
   AUTO-SAVE: globalni listener
   (hvata sve input/select/textarea promjene)
--------------------------------*/
document.addEventListener("input", (e)=>{
  const tag = (e.target?.tagName || "").toLowerCase();
  if(tag === "input" || tag === "select" || tag === "textarea") scheduleAutoSave();
});
document.addEventListener("change", (e)=>{
  const tag = (e.target?.tagName || "").toLowerCase();
  if(tag === "input" || tag === "select" || tag === "textarea") scheduleAutoSave();
});

/* Auto-load na start (ako postoji) */
(function autoLoadOnStart(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    if(raw){
      const data = JSON.parse(raw);
      importState(data);
      toast("Auto-load", "Vraƒáeni zadnji spremljeni podaci.", "good");
    }
  } catch(e){}
})();
</script>
</body>
</html>
