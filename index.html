<!DOCTYPE html>
<html lang="hr">
<head>
<meta charset="UTF-8">
<title>Protokol</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
body{margin:0;background:#000;color:#fff;font-family:Arial}
.container{max-width:1000px;margin:auto;padding:20px}
.section{background:#1e1e1e;padding:15px;border-radius:10px;margin-bottom:20px}
.group{border:1px solid #444;padding:15px;border-radius:10px;margin-bottom:20px}
label{display:block;margin-top:8px}
input,select,textarea,button{width:100%;padding:8px;margin-top:4px;background:#333;color:#fff;border:none;border-radius:6px}
button{background:#555;font-weight:bold;cursor:pointer}
button:hover{background:#777}
.hidden{display:none}
.apparow{border:1px solid #555;padding:10px;margin-top:10px;border-radius:6px}
footer{text-align:center;color:#aaa;font-size:12px}
</style>
</head>
<body>
<div class="container">

<h1 style="text-align:center">Protokol</h1>

<div id="security" class="section">
<h3>Security</h3>
<label>Unesite kod:</label>
<input type="text" id="secCode">
<button onclick="checkSecurity()">Potvrdi</button>
</div>

<div id="mainApp" class="hidden">
<div class="section">
<button onclick="addGroup()">‚ûï Dodaj grupu aparata</button>
<button onclick="generateText()">üìÑ Generiraj sav tekst</button>
</div>

<div id="uploadSection" class="section hidden">
<label>Upload Excel baze</label>
<input type="file" id="excelFile">
</div>

<div id="groups"></div>

<div class="section hidden" id="outBox">
<h3>Generirani tekst</h3>
<textarea id="output" rows="25"></textarea>
</div>
</div>

<footer>verzija 13.1.26</footer>

<script>
let isAdmin=false;
let excelData={}; // Ovdje ƒçuvamo podatke iz Excel-a

function checkSecurity(){
  const code=document.getElementById("secCode").value.trim();
  if(code==="1"){
    document.getElementById("mainApp").classList.remove("hidden");
  } else if(code==="0456"){
    document.getElementById("mainApp").classList.remove("hidden");
    isAdmin=true;
    document.getElementById("uploadSection").classList.remove("hidden");
  } else {
    alert("Neispravan kod!");
  }
}

// ---------- Excel uƒçitavanje ----------
document.getElementById("excelFile")?.addEventListener("change", async(e)=>{
  const file=e.target.files[0];
  if(!file) return;
  const data=await file.arrayBuffer();
  const wb=XLSX.read(data,{type:"array"});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const json=XLSX.utils.sheet_to_json(ws,{header:1});
  parseExcel(json);
});

function parseExcel(json){
  // Pretpostavljamo da je prvi red zaglavlje, ostalo su podaci
  // Excel mo≈æe imati kolone: Kategorija, Model, Exciter, Software, SoftwareCategory...
  excelData={};
  json.slice(1).forEach(row=>{
    const cat=row[0], model=row[1];
    if(!cat || !model) return;
    if(!excelData[cat]) excelData[cat]=[];
    excelData[cat].push(model);
  });
  alert("Excel uƒçitan, dropdownovi ƒáe koristiti ove podatke!");
}

// ---------- Dinamika grupa ----------
let groupCount=0;
function addGroup(){
  groupCount++;
  const g=document.createElement("div");
  g.className="group";
  g.innerHTML=`
  <h3>Grupa ${groupCount}</h3>

  <label>Broj aparata</label>
  <input type="number" min="1" onchange="renderAparati(this)">

  <label>Kategorija</label>
  <select onchange="updateModels(this)">
    <option value="">-- odaberi --</option>
  </select>

  <label>Model</label>
  <select class="model"><option></option></select>

  <div class="aparati"></div>

  <hr>

  <label>Bill Acceptor</label>
  <select onchange="toggle(this)">
    <option>Ne</option><option>Da</option>
  </select>
  <select class="hidden dep">
    <option value="">MEI / JCM</option>
    <option>MEI</option><option>JCM</option>
  </select>
  <input type="number" class="hidden dep" placeholder="Broj komada">

  <label>Printer</label>
  <select onchange="toggle(this)">
    <option>Ne</option><option>Da</option>
  </select>
  <select class="hidden dep">
    <option>Ithaca</option><option>Ithaca Edge</option><option>Gen2</option><option>Gen5</option>
  </select>
  <input type="number" class="hidden dep" placeholder="Broj komada">

  <label>Server</label>
  <select onchange="toggleServer(this)">
    <option>Ne</option><option>Da</option>
  </select>

  <div class="server hidden">
    <label>JPSN</label><input>
    <label>Verzija (PPC)</label>
    <select>
      <option>PPC2_8_148</option>
      <option>PPC2_10_189</option>
      <option>PPC3_G2_13_332</option>
      <option>PPC3_G3_13_361</option>
      <option>PPC3_G3_14_372</option>
    </select>

    <h4>Mini</h4>
    <input placeholder="Visible"><input placeholder="Hidden"><input placeholder="Min bet">
    <h4>Mid</h4>
    <input placeholder="Visible"><input placeholder="Hidden"><input placeholder="Min bet">
    <h4>Super</h4>
    <input placeholder="Visible"><input placeholder="Hidden"><input placeholder="Min bet">
  </div>
  `;
  document.getElementById("groups").appendChild(g);

  // Popuni kategorije iz Excel-a ako postoji
  const catSelect=g.querySelector("select");
  const cats=Object.keys(excelData);
  if(cats.length) cats.forEach(c=>{const o=document.createElement("option"); o.textContent=c; catSelect.appendChild(o);});
  else catSelect.innerHTML+=`<option>Premier</option><option>G-Series</option><option>Supreme</option>`;
}

// ---------- Dinamika aparata ----------
function renderAparati(inp){
  const box=inp.parentElement.querySelector(".aparati");
  box.innerHTML="";
  for(let i=1;i<=inp.value;i++){
    box.innerHTML+=`
    <div class="apparow">
      <h4>Aparat ${i}</h4>
      <label>Serijski broj</label><input>
      <label>Exciter</label><input>
      <label>Exciter Software</label>
      <select onchange="showSoftCat(this)">
        <option value="">--</option>
        <option value="3">3</option>
        <option value="4">4</option>
      </select>
      <label class="hidden">Software kategorija</label>
      <select class="hidden" onchange="showSoftList(this)">
        <option>Collection</option><option>Power</option><option>General</option>
      </select>
      <label class="hidden">Software</label>
      <select class="hidden"></select>
    </div>`;
  }
}

// ---------- Software ----------
function showSoftCat(sel){
  const row=sel.parentElement;
  row.querySelectorAll("label,select").forEach(e=>{
    if(e!==sel && (e.tagName==="LABEL" || e.tagName==="SELECT")) e.classList.add("hidden");
  });
  row.querySelectorAll("label")[3].classList.remove("hidden");
  row.querySelectorAll("select")[1].classList.remove("hidden");
}
function showSoftList(sel){
  const row=sel.parentElement;
  const exc=row.querySelectorAll("select")[0].value;
  const list=row.querySelectorAll("select")[2];
  list.innerHTML="";
  (softwareData[exc]?.[sel.value]||[]).forEach(s=>{
    const o=document.createElement("option"); o.textContent=s; list.appendChild(o);
  });
  row.querySelectorAll("label")[4].classList.remove("hidden");
  list.classList.remove("hidden");
}

// ---------- Helpers ----------
function updateModels(sel){
  const m=sel.parentElement.querySelector(".model");
  m.innerHTML="";
  const cat=sel.value;
  if(excelData[cat]){
    excelData[cat].forEach(v=>{const o=document.createElement("option"); o.textContent=v; m.appendChild(o);});
  }
}
function toggle(sel){
  const deps=sel.parentElement.querySelectorAll(".dep");
  deps.forEach(d=>d.classList.toggle("hidden",sel.value!=="Da"));
}
function toggleServer(sel){
  sel.parentElement.querySelector(".server").classList.toggle("hidden",sel.value!=="Da");
}

// ---------- Output ----------
function generateText(){
  let t="";
  document.querySelectorAll(".group").forEach((g,i)=>{
    t+=`Grupa ${i+1}\n`;
    g.querySelectorAll(".apparow").forEach((a,j)=>{
      const i=a.querySelectorAll("input,select");
      t+=`Aparat ${j+1}:\n`;
      t+=`  Serijski broj: ${i[0].value}\n`;
      t+=`  Exciter: ${i[1].value}\n`;
      t+=`  Exciter Software: ${i[2].value}\n`;
      if(i[3] && i[3].value) t+=`  Software kategorija: ${i[3].value}\n  Software: ${i[4].value}\n`;
    });

    // Oprema
    g.querySelectorAll("select, input").forEach(el=>{
      if(el.parentElement.classList.contains("apparow")) return;
      if(el.previousElementSibling){
        const lbl=el.previousElementSibling.textContent;
        if(el.value && el.value!=="Ne") t+=`${lbl}: ${el.value}\n`;
      }
    });

    // Server
    if(g.querySelector(".server") && !g.querySelector(".server").classList.contains("hidden")){
      t+="Server:\n";
      g.querySelector(".server").querySelectorAll("input,select").forEach(el=>{
        const lbl=el.previousElementSibling ? el.previousElementSibling.textContent : "";
        if(lbl) t+=`${lbl}: ${el.value}\n`;
      });
    }

    t+="\n";
  });

  document.getElementById("output").value=t;
  document.getElementById("outBox").classList.remove("hidden");
}
</script>
</body>
</html>